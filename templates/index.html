<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AMIC Construction PPE Detection</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background-color: #1a1a1a; /* Near-black background */
        color: #ffffff; /* White text for contrast */
        font-family: Arial, sans-serif;
      }
      h1 {
        margin: 20px 0;
        font-size: 2em;
      }
      .video-container {
        position: relative;
        max-width: 100%;
      }
      #video-feed {
        max-width: 100%;
        height: auto;
        border: 2px solid #ffffff;
      }
      #overlay-canvas {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none; /* Allow clicks to pass through to the video */
      }
      .logo {
        position: absolute;
        bottom: 10px;
        right: 10px;
        width: 100px; /* Adjust size as needed */
        opacity: 0.8;
      }
      #warning {
        margin-top: 20px;
        font-size: 1.2em;
        color: #ff4444; /* Red for warnings */
        font-weight: bold;
        display: none; /* Hidden by default */
      }
      .prompt-container {
        margin: 20px 0;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
      }
      #prompt-input {
        padding: 8px;
        font-size: 1em;
        background-color: #333;
        color: #ffffff;
        border: 1px solid #555;
        border-radius: 4px;
        width: 300px;
      }
      #update-btn {
        padding: 8px 16px;
        font-size: 1em;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      #update-btn:hover {
        background-color: #45a049;
      }
      #clear-btn {
        padding: 8px 16px;
        font-size: 1em;
        background-color: #ff4444; /* Red to indicate a stop/pause action */
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      #clear-btn:hover {
        background-color: #cc0000;
      }
      #toggle-mode-btn {
        padding: 8px 16px;
        font-size: 1em;
        background-color: #1e90ff; /* Blue to indicate a toggle action */
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      #toggle-mode-btn:hover {
        background-color: #1c86ee;
      }
    </style>
    <script>
      let detections = [];
      let showSegmentation = false;
      let canvas, ctx;

      function initCanvas() {
        const videoFeed = document.getElementById('video-feed');
        canvas = document.getElementById('overlay-canvas');
        ctx = canvas.getContext('2d');

        // Set canvas size to match video feed
        videoFeed.onload = function() {
          console.log("Video feed loaded, setting canvas size");
          canvas.width = videoFeed.width;
          canvas.height = videoFeed.height;
          drawDetections();
        };

        videoFeed.onerror = function() {
          console.error("Error loading video feed");
          document.getElementById('warning').textContent = "Error: Could not load video stream.";
          document.getElementById('warning').style.display = "block";
        };

        // Adjust canvas size if the video feed resizes
        videoFeed.addEventListener('resize', function() {
          console.log("Video feed resized, updating canvas size");
          canvas.width = videoFeed.width;
          canvas.height = videoFeed.height;
        });

        // Start polling for detections
        console.log("Starting to poll for detections");
        setInterval(fetchDetections, 100); // Poll every 100ms

        // Continuously redraw the canvas to ensure overlays stay in sync
        function redrawLoop() {
          drawDetections();
          requestAnimationFrame(redrawLoop);
        }
        redrawLoop();
      }

      function fetchDetections() {
        fetch('/detections')
          .then(response => response.json())
          .then(data => {
            detections = data.detections || [];
            console.log("Fetched detections:", detections);
            updateWarnings();
          })
          .catch(error => console.error("Error fetching detections:", error));
      }

      function drawDetections() {
        if (!ctx) return;

        // Clear the canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw detections
        detections.forEach(det => {
          const { x1, y1, x2, y2, class: label, confidence, color, mask } = det;
          const [r, g, b] = color;

          if (showSegmentation && mask) {
            // Draw segmentation mask
            const maskData = new Uint8ClampedArray(mask.flat());
            const maskImage = new ImageData(maskData, canvas.width, canvas.height);
            for (let i = 0; i < maskImage.data.length; i += 4) {
              if (maskImage.data[i] > 0) {
                maskImage.data[i] = r;     // Red
                maskImage.data[i + 1] = g; // Green
                maskImage.data[i + 2] = b; // Blue
                maskImage.data[i + 3] = 76; // Alpha (30% opacity)
              } else {
                maskImage.data[i + 3] = 0; // Transparent
              }
            }
            ctx.putImageData(maskImage, 0, 0);
            // Draw label above the mask
            ctx.font = '20px Arial';
            ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
            ctx.fillText(`${label} (${confidence.toFixed(2)})`, x1, y1 - 10);
          } else {
            // Draw bounding box
            ctx.strokeStyle = `rgb(${r}, ${g}, ${b})`;
            ctx.lineWidth = 2;
            ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
            // Draw label
            ctx.font = '20px Arial';
            ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
            ctx.fillText(`${label} (${confidence.toFixed(2)})`, x1, y1 - 10);
          }
        });
      }

      // Fetch detection data and update warning
      function updateWarnings() {
        const warningDiv = document.getElementById("warning");
        const noHelmet = detections.some(d => d.class === "worker without helmet");
        const noVest = detections.some(d => d.class === "no-vest");

        if (noHelmet || noVest) {
          let warningText = "WARNING: ";
          if (noHelmet) warningText += "No helmet detected. ";
          if (noVest) warningText += "No vest detected.";
          warningDiv.textContent = warningText;
          warningDiv.style.display = "block";
        } else {
          warningDiv.style.display = "none";
        }
      }

      // Function to update prompts
      function updatePrompts() {
        const promptInput = document.getElementById("prompt-input").value;
        if (promptInput.trim() === "") {
          alert("Please enter at least one prompt.");
          return;
        }
        fetch(`/update_prompts/${encodeURIComponent(promptInput)}`)
          .then((response) => response.json())
          .then((data) => {
            console.log("Prompts updated:", data.prompts);
            alert("Prompts updated successfully!");
          })
          .catch((error) => {
            console.error("Error updating prompts:", error);
            alert("Failed to update prompts.");
          });
      }

      // Function to clear prompts and toggle pause
      function clearPrompts() {
        fetch('/clear_prompts')
          .then(response => response.json())
          .then(data => {
            console.log("Prompts cleared, pause state:", data.paused);
            document.getElementById('prompt-input').value = ''; // Clear the input field
            const clearBtn = document.getElementById('clear-btn');
            clearBtn.textContent = data.paused ? 'Resume Inference' : 'Clear Prompts'; // Update button text
            alert(data.paused ? "Inference paused." : "Inference resumed.");
            if (!data.paused && data.prompts.length === 0) {
              document.getElementById('warning').textContent = "Inference paused: Add new prompts to resume.";
              document.getElementById('warning').style.display = "block";
            }
          })
          .catch(error => {
            console.error("Error clearing prompts:", error);
            alert("Failed to clear prompts.");
          });
      }

      // Function to toggle between bounding boxes and segmentation
      function toggleDisplayMode() {
        fetch('/toggle_display_mode')
          .then(response => response.json())
          .then(data => {
            console.log("Display mode toggled, show_segmentation:", data.show_segmentation);
            showSegmentation = data.show_segmentation;
            const toggleBtn = document.getElementById('toggle-mode-btn');
            toggleBtn.textContent = data.show_segmentation ? 'Switch to Bounding Boxes' : 'Switch to Segmentation';
          })
          .catch(error => {
            console.error("Error toggling display mode:", error);
            alert("Failed to toggle display mode.");
          });
      }

      // Initialize the canvas when the page loads
      window.onload = initCanvas;
    </script>
  </head>
  <body>
    <h1>AMIC Construction PPE Detection</h1>
    <div class="prompt-container">
      <input
        type="text"
        id="prompt-input"
        placeholder="Enter prompts (e.g., worker with helmet, heavy machinery)"
      />
      <button id="update-btn" onclick="updatePrompts()">Update Prompts</button>
      <button id="clear-btn" onclick="clearPrompts()">Clear Prompts</button>
      <button id="toggle-mode-btn" onclick="toggleDisplayMode()">Switch to Segmentation</button>
    </div>
    <div class="video-container">
      <img id="video-feed" src="{{ url_for('video_feed') }}" alt="Video Feed" />
      <canvas id="overlay-canvas"></canvas>
      <img src="/static/joint_logo.png" class="logo" alt="AMIC Logo" />
    </div>
    <div id="warning"></div>
  </body>
</html>