<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ROI Person Detection</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background-color: #1a1a1a;
        color: #ffffff;
        font-family: Arial, sans-serif;
      }
      h1 {
        margin: 20px 0;
        font-size: 2em;
      }
      .container {
        display: flex;
        width: 100%;
        max-width: 1200px;
        justify-content: space-between;
        gap: 20px;
      }
      .video-container {
        position: relative;
        max-width: 70%;
        flex: 1;
      }
      #video-feed {
        max-width: 100%;
        height: auto;
        border: 2px solid #ffffff;
        -webkit-user-drag: none;
        user-drag: none;
        user-select: none;
      }
      #canvas-overlay {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: all;
      }
      .logo {
        position: absolute;
        bottom: 10px;
        right: 10px;
        width: 100px;
        opacity: 0.8;
      }
      #warning {
        margin-top: 20px;
        font-size: 1.2em;
        color: #ff4444;
        font-weight: bold;
        display: none;
      }
      #roi-instructions {
        margin-top: 10px;
        font-size: 1em;
        color: #cccccc;
      }
      .roi-panel {
        max-width: 25%;
        flex: 0 0 25%;
        padding: 10px;
        background-color: #333;
        border-radius: 5px;
        overflow-y: auto;
      }
      .roi-item {
        margin: 10px 0;
        padding: 5px;
        background-color: #444;
        border-radius: 3px;
      }
      .roi-item input[type="text"] {
        width: 60%;
        margin-right: 5px;
        background-color: #555;
        color: #fff;
        border: 1px solid #666;
        padding: 2px;
      }
      .roi-item input[type="checkbox"] {
        margin-left: 5px;
      }
      .roi-item button {
        background-color: #ff4444;
        border: none;
        padding: 2px 5px;
        color: white;
        cursor: pointer;
      }
      .detection-list {
        margin-top: 10px;
        max-height: 200px;
        overflow-y: auto;
        font-size: 0.9em;
      }
      .dashboard-link, .mqtt-section, .reset-section {
        margin-top: 10px;
        font-size: 1em;
      }
      .dashboard-link a {
        color: #00ccff;
        text-decoration: none;
      }
      .dashboard-link a:hover {
        text-decoration: underline;
      }
      .mqtt-section input {
        background-color: #555;
        color: #fff;
        border: 1px solid #666;
        padding: 5px;
        width: 200px;
      }
      .mqtt-section button, .reset-button {
        background-color: #00ccff;
        border: none;
        padding: 5px 10px;
        color: white;
        cursor: pointer;
        margin-left: 5px;
        border-radius: 4px;
      }
      .reset-button {
        background-color: #ff4444;
      }
      #mqtt-status {
        margin-top: 5px;
        font-size: 0.9em;
        color: #cccccc;
      }
    </style>
    <script>
      let drawing = false;
      let startX, startY;
      let canvas, ctx;
      let isEditing = false;
      let updateInterval;
      let rois = [];
      let detections = [];

      function setupCanvas() {
        const video = document.getElementById("video-feed");
        if (!video) {
          console.error("Video element not found");
          return;
        }
        canvas = document.createElement("canvas");
        canvas.width = video.clientWidth;
        canvas.height = video.clientHeight;
        ctx = canvas.getContext("2d");
        document.querySelector(".video-container").appendChild(canvas);
        canvas.id = "canvas-overlay";
        console.log("Canvas set up:", canvas.width, "x", canvas.height);

        // Adjust canvas size when video loads or window resizes
        video.addEventListener("loadedmetadata", adjustCanvasSize);
        window.addEventListener("resize", adjustCanvasSize);
      }

      function adjustCanvasSize() {
        const video = document.getElementById("video-feed");
        canvas.width = video.clientWidth;
        canvas.height = video.clientHeight;
        drawVisualizations();
      }

      function drawDashedLine(ctx, x1, y1, x2, y2, color, dashLength = 5) {
        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = 1;
        ctx.setLineDash([dashLength, dashLength]);
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
        ctx.setLineDash([]); // Reset dash pattern
      }

      function drawVisualizations() {
        if (!ctx) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw ROIs
        rois.forEach(roi => {
          if (!roi.enabled) return;
          const [x1, y1] = roi.coords[0];
          const [x2, y2] = roi.coords[1];
          const color = `rgb(${roi.color[2]}, ${roi.color[1]}, ${roi.color[0]})`;

          // Draw ROI outline (dashed)
          ctx.beginPath();
          ctx.strokeStyle = color;
          ctx.lineWidth = 1;
          ctx.globalAlpha = 0.4;
          drawDashedLine(ctx, x1, y1, x2, y1, color); // Top
          drawDashedLine(ctx, x2, y1, x2, y2, color); // Right
          drawDashedLine(ctx, x2, y2, x1, y2, color); // Bottom
          drawDashedLine(ctx, x1, y2, x1, y1, color); // Left
          ctx.globalAlpha = 1.0;

          // Draw ROI label inside top-left corner
          ctx.font = "16px Arial";
          ctx.fillStyle = "black";
          ctx.fillText(roi.name, x1 + 5, y1 + 20);
          ctx.fillStyle = color;
          ctx.fillText(roi.name, x1 + 5, y1 + 20);
        });

        // Draw detections
        detections.forEach(d => {
          const [x1, y1, x2, y2] = d.box;
          const inRoi = d.in_roi.length > 0;
          const color = inRoi ? "red" : "green";

          // Draw detection outline (dashed)
          ctx.beginPath();
          ctx.strokeStyle = color;
          ctx.lineWidth = 1;
          ctx.globalAlpha = 0.6;
          drawDashedLine(ctx, x1, y1, x2, y1, color); // Top
          drawDashedLine(ctx, x2, y1, x2, y2, color); // Right
          drawDashedLine(ctx, x2, y2, x1, y2, color); // Bottom
          drawDashedLine(ctx, x1, y2, x1, y1, color); // Left
          ctx.globalAlpha = 1.0;

          // Draw detection label
          const label = `${d.class} (${d.confidence.toFixed(2)})`;
          ctx.font = "16px Arial";
          ctx.fillStyle = "black";
          ctx.fillText(label, x1, y1 - 10);
          ctx.fillStyle = color;
          ctx.fillText(label, x1, y1 - 10);
        });
      }

      function updateUI() {
        if (isEditing) return;
        console.log("updateUI called at", new Date().toISOString());
        fetch("/detections")
          .then((response) => {
            if (!response.ok)
              throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
          })
          .then((data) => {
            console.log("Detections data:", JSON.stringify(data, null, 2));
            const warningDiv = document.getElementById("warning");
            let personsInROI = [];
            detections = data.detections.map(d => ({
              box: [
                d.x - d.width / 2,
                d.y - d.height / 2,
                d.x + d.width / 2,
                d.y + d.height / 2
              ],
              class: d.class,
              confidence: d.confidence,
              in_roi: d.in_roi
            }));
            rois = data.rois;

            if (detections.some(d => d.in_roi.length > 0)) {
              personsInROI = detections.flatMap(d => d.in_roi);
              warningDiv.textContent = personsInROI
                .map((p) => `WARNING: Person in ${p.name} at ${p.time}`)
                .join(" | ");
              warningDiv.style.display = "block";
              console.log("Warnings triggered:", personsInROI);
            } else {
              warningDiv.style.display = "none";
              console.log("No persons in ROI detected");
            }

            const focusedElement = document.activeElement;
            const focusedId = focusedElement && focusedElement.tagName === "INPUT" && focusedElement.type === "text" ? focusedElement.getAttribute("data-id") : null;
            const focusedValue = focusedElement && focusedElement.tagName === "INPUT" && focusedElement.type === "text" ? focusedElement.value : null;

            const roiPanel = document.getElementById("roi-panel");
            roiPanel.innerHTML = "";
            data.rois.forEach((roi) => {
              const div = document.createElement("div");
              div.className = "roi-item";
              div.style.borderLeft = `5px solid rgb(${roi.color[2]}, ${roi.color[1]}, ${roi.color[0]})`;
              div.innerHTML = `
                <input type="text" value="${roi.name}" data-id="${roi.id}">
                <input type="checkbox" ${roi.enabled ? 'checked' : ''} onchange="toggleROI(${roi.id}, this.checked)">
                <button onclick="deleteROI(${roi.id})">Delete</button>
                <div class="detection-list">${roi.detections
                  .map((d) => `<div>${d.time}</div>`)
                  .join("")}</div>
              `;
              roiPanel.appendChild(div);
            });

            if (focusedId) {
              const input = document.querySelector(`input[data-id="${focusedId}"]`);
              if (input) {
                input.focus();
                input.value = focusedValue;
              }
            }

            // Redraw visualizations after updating ROIs and detections
            drawVisualizations();
          })
          .catch((error) => console.error("Error fetching detections:", error));
      }

      function startDrawing(event) {
        if (!canvas || !ctx) {
          console.error("Canvas or context not initialized");
          return;
        }
        const rect = canvas.getBoundingClientRect();
        startX = event.clientX - rect.left;
        startY = event.clientY - rect.top;
        drawing = true;
        canvas.addEventListener("mousemove", drawPreview);
      }

      function drawPreview(event) {
        if (!drawing || !ctx) return;
        const rect = canvas.getBoundingClientRect();
        const currentX = event.clientX - rect.left;
        const currentY = event.clientY - rect.top;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawVisualizations(); // Redraw existing ROIs and detections
        ctx.strokeStyle = "green";
        ctx.lineWidth = 2;
        ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
      }

      function stopDrawing(event) {
        if (!drawing || !ctx) return;
        const rect = canvas.getBoundingClientRect();
        const endX = event.clientX - rect.left;
        const endY = event.clientY - rect.top;
        drawing = false;
        canvas.removeEventListener("mousemove", drawPreview);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawVisualizations(); // Redraw existing ROIs and detections

        fetch("/add_roi", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            start: { x: startX, y: startY },
            end: { x: endX, y: endY },
          }),
        })
          .then((response) => response.json())
          .then(() => updateUI())
          .catch((error) => console.error("Error adding ROI:", error));
      }

      function updateROIName(id, name) {
        fetch("/update_roi_name", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: id, name: name }),
        })
          .then((response) => response.json())
          .then(() => {
            isEditing = false;
            updateUI();
          })
          .catch((error) => console.error("Error updating ROI name:", error));
      }

      function toggleROI(id, enabled) {
        fetch("/toggle_roi", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: id, enabled: enabled }),
        })
          .then((response) => response.json())
          .then(() => updateUI())
          .catch((error) => console.error("Error toggling ROI:", error));
      }

      function deleteROI(id) {
        fetch("/delete_roi", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: id }),
        })
          .then((response) => response.json())
          .then(() => updateUI())
          .catch((error) => console.error("Error deleting ROI:", error));
      }

      function connectMQTT() {
        const brokerInput = document.getElementById("mqtt-broker").value;
        const statusDiv = document.getElementById("mqtt-status");
        
        fetch("/connect_mqtt", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ broker: brokerInput }),
        })
          .then((response) => response.json())
          .then((data) => {
            statusDiv.textContent = data.message;
            statusDiv.style.color = data.status === "success" ? "#00ff00" : "#ff4444";
          })
          .catch((error) => {
            statusDiv.textContent = "Error connecting to MQTT: " + error;
            statusDiv.style.color = "#ff4444";
          });
      }

      function resetDatabase() {
        if (confirm("Are you sure you want to reset the database? This will delete all detections.")) {
          fetch("/reset_db", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({})
          })
            .then((response) => response.json())
            .then((data) => alert(data.status))
            .catch((error) => console.error("Error resetting database:", error));
        }
      }

      window.onload = () => {
        try {
          setupCanvas();
          if (canvas) {
            canvas.addEventListener("mousedown", startDrawing);
            canvas.addEventListener("mouseup", stopDrawing);
          } else {
            console.error("Canvas not initialized, drawing disabled");
          }

          const roiPanel = document.getElementById("roi-panel");
          roiPanel.addEventListener("focusin", (event) => {
            if (event.target.tagName === "INPUT" && event.target.type === "text") {
              isEditing = true;
            }
          }, true);

          roiPanel.addEventListener("focusout", (event) => {
            if (event.target.tagName === "INPUT" && event.target.type === "text") {
              const id = parseInt(event.target.getAttribute("data-id"));
              const name = event.target.value;
              updateROIName(id, name);
            }
          }, true);

          roiPanel.addEventListener("keypress", (event) => {
            if (event.target.tagName === "INPUT" && event.target.type === "text" && event.key === "Enter") {
              const id = parseInt(event.target.getAttribute("data-id"));
              const name = event.target.value;
              updateROIName(id, name);
              event.target.blur();
            }
          });

          updateUI();
          updateInterval = setInterval(() => {
            updateUI();
          }, 1000);

          const statusDiv = document.getElementById("mqtt-status");
          statusDiv.textContent = "{{ 'Connected to MQTT' if mqtt_connected else 'Not connected to MQTT' }}";
          statusDiv.style.color = "{{ '#00ff00' if mqtt_connected else '#cccccc' }}";
        } catch (error) {
          console.error("Error in window.onload:", error);
        }
      };
    </script>
  </head>
  <body>
    <h1>ROI Person Detection</h1>
    <div class="container">
      <div class="video-container">
        <img id="video-feed" src="{{ url_for('video_feed') }}" alt="Video Feed" 
             onerror="this.style.display='none'; document.getElementById('video-error').style.display='block';">
        <div id="video-error" style="display: none; color: #ff4444; font-weight: bold;">
          Unable to load video feed from Jetson. Please ensure the inference service is running.
        </div>
        <img src="{{ url_for('static', filename='joint_logo.png') }}" class="logo" alt="Logo" />
      </div>
      <div class="roi-panel" id="roi-panel">
        {% for roi in rois %}
        <div class="roi-item" style="border-left: 5px solid rgb({{ roi.color[2] }}, {{ roi.color[1] }}, {{ roi.color[0] }});">
          <input type="text" value="{{ roi.name }}" data-id="{{ roi.id }}">
          <input type="checkbox" {{ 'checked' if roi.enabled else '' }} onchange="toggleROI({{ roi.id }}, this.checked)">
          <button onclick="deleteROI({{ roi.id }})">Delete</button>
          <div class="detection-list">
            {% for detection in roi.detections %}
            <div>{{ detection.time }}</div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    <div id="warning"></div>
    <div id="roi-instructions">
      Click and drag on the video feed to draw a rectangular region of interest.
    </div>
    <div class="dashboard-link">
      <a href="{{ url_for('dashboard') }}">View Detection Dashboard</a>
    </div>
    <div class="mqtt-section">
      <input type="text" id="mqtt-broker" placeholder="Enter MQTT Broker (e.g., mqtt-broker)" value="mqtt-broker">
      <button onclick="connectMQTT()">Connect to MQTT</button>
      <div id="mqtt-status"></div>
    </div>
    <div class="reset-section">
      <button class="reset-button" onclick="resetDatabase()">Reset Database</button>
    </div>
  </body>
</html>